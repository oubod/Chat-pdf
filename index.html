<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedBot Pro - Assistant IA Médical</title>
    <meta name="description" content="Assistant IA médical professionnel pour étudiants en médecine - Par Oubeida Aryan">
    <meta name="theme-color" content="#2563eb">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk1lZEJvdCBQcm8gLSBBc3Npc3RhbnQgSUEgTcOpZGljYWwiLAogICJzaG9ydF9uYW1lIjogIk1lZEJvdCBQcm8iLAogICJkZXNjcmlwdGlvbiI6ICJBc3Npc3RhbnQgSUEgbcOpZGljYWwgcHJvZmVzc2lvbm5lbCBwb3VyIMOpdHVkaWFudHMgZW4gbcOpZGVjaW5lIC0gUGFyIE91YmVpZGEgQXJ5YW4iLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2Y5ZmFmYiIsCiAgInRoZW1lX2NvbG9yIjogIiMyNTYzZWIiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMGlNVEk0SWlCb1pXbG5hSFE5SWpFeU9DSWdkbWx6ZDJKdmVEMGlNQ0F3SURFeU9DQXhNamdpSUhodGJHNXpQU0pvZEhSd09pOHZkM2QzTG5jekxtOXlaeTh5TURBd0wzTjJaeUkrUEhKbFkzUWdlRDBpTUNJZ2VUMGlNQ0lnZDJsa2RHZzlJakV5T0NJZ2FHVnBaMmgwUFNJeE1qZ2lJR1pwYkd3OUlpTXlOVFl6WldJaUx6NDhaM0poWkdsbGJuUWdhV1E5SW1keVlXUWlJR04wY21Ga2FXVnVkRlZ1YVhSelBTSnZZbXBsWTNSQ2IzVnVaR2x1WjBKdmVDSStQSE4wYjNBZ2IyWm1jMlYwUFNJd0pTSWdjM1J2Y0MxamIyeHZjajBpSXpJMU5qTmxZaUl2UGp4emRHOXdJRzltWm5ObGREMGlNVEFsU1NJZ2MzUnZjQzFqYjJ4dmNqMGlJek15TnpneVpqWWlMejQ4TDJkeVlXUnBaVzUwUGp4amFYSmpiR1VnWTNnOUlqWTBJaUJqZVQwaU5qUWlJSEk5SWpJeElpQm1hV3hzUFNKM2FHbDBaU0l2UGp4d1lYUm9JR1E5SWt0c09UQTJMa2t5TnpNdU9VVmpPVGd1TlRBeElqUTNOQzR5TXpFeE1UVXVOR1VpSUdacGJHdzlJaU15TlRZelpXSWlMejQ4TDNOMlp6ND0iLAogICAgICAic2l6ZXMiOiAiMTI4eDEyOCIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9LAogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU5URXlJaUJvWldsbmFIUTlJalV4TWlJZ2RtbGxkMEp2ZUQwaU1DQXdJRFV4TWlBMU1USWlJSGh0Ykc1elBTSm9kSFJ3T2k4dmQzZDNMbmN6TG05eVp5OHlNREF3TDNOMlp5SStQSEpsWTNRZ2VEMGlNQ0lnZVQwaU1DSWdkMmxrZEdnOUlqVXhNaUlnYUdWcFoyaDBQU0kxTVRJaUlHWnBiR3c5SWlNeU5UWXpaV0lpTHo0OFozSmhaR2xsYm5RZ2FXUTlJbWR5WVdRaUlHTjBjbUZrYVdWdWRGVnVhWFJ6UFNKdlltcGxZM1JDYjNWdVpHbHVaMEp2ZUNJK1BITjBiM0FnYjJabWMyVjBQU0l3SlNJZ2MzUnZjQzFqYjJ4dmNqMGlJekkyTkRObFlpSXZQanh6ZEc5d0lHOW1abk5sZEQwaU1UQWxTeUlnYzNSdmNDMWpiMnh2Y2owaUl6TXlOemhpWXlJdlBqd3ZaM0poWkdsbGJuUStQR05wY21Oc1pTQmplRDBpTWpVMklpQmplVDBpTWpVMklpQnlQU0l5TVRJZ1ptbHNiRDBpZDJocGRHVWlMejQ4Y0dGMGFDQmtQU0pOTVRNM0xqZGpOUzR4TFMxd0xUSTBMVEV3SWl0aU5TQm1TVEUzTGpOeE1UWXROak5zTFRrM0lpQm1hV3hzUFNKdlluVmxhV1JoSUdGeWVXRnVKejRQSEJoZEdnZ1pEMGlTekU0WVRrdU5qWmpOUzQwTnkwNExqZHROQzQ0Tnl0aUl6QXVNaTB4Tml0QmFUSXROREYzSjJGNWNIQklhWFJ6SWlCbWFXeHNQU0luU3psME1IVnhhSEVnUVhKNVlXNGlMejQ4TDNOMlp6ND0iLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXSwKICAiY2F0ZWdvcmllcyI6IFsiZWR1Y2F0aW9uIiwgImhlYWx0aCIsICJtZWRpY2FsIl0sCiAgImxhbmciOiAiZnIiCn0=">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEyOCIgaGVpZ2h0PSIxMjgiIGZpbGw9IiMyNTYzZWIiLz48ZyByYWRpZW50PSJvYmpCb3VuZGluZ0JveCI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzI1NjNlYiIvPjxzdG9wIG9mZnNldD0iMTAlIiBzdG9wLWNvbG9yPSIjMzI3OGY2Ii8+PC9ncmFkaWVudD4+PGNpcmNsZSBjeD0iNjQiIGN5PSI2NCIgcj0iMjEiIGZpbGw9IndoaXRlIi8+PHBhdGggZD0iTTU3LjZjNS4xLTEgMTItNiAxNC04dDggZklXMTcuM3ExNi02M2wtOTciIGZpbGw9IiMyNTYzZWIiLz48L3N2Zz4=">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a'
                        },
                        medical: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d'
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        * { 
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        .chat-bubble {
            max-width: 90%;
            word-wrap: break-word;
            backdrop-filter: blur(10px);
        }
        
        .user-bubble {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border-radius: 18px 18px 4px 18px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
        }
        
        .bot-bubble {
            background: rgba(248, 250, 252, 0.95);
            color: #374151;
            border: 1px solid rgba(226, 232, 240, 0.8);
            border-radius: 18px 18px 18px 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .dark .bot-bubble {
            background: rgba(55, 65, 81, 0.95);
            color: #e5e7eb;
            border-color: rgba(75, 85, 99, 0.6);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .dark .glass-card {
            background: rgba(31, 41, 55, 0.9);
            border-color: rgba(75, 85, 99, 0.3);
        }
        
        .quiz-container {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(168, 85, 247, 0.08) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin: 12px 0;
        }
        
        .dark .quiz-container {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(168, 85, 247, 0.15) 100%);
            border-color: rgba(139, 92, 246, 0.3);
        }
        
        .quiz-question {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }
        
        .dark .quiz-question {
            background: #374151;
            border-color: #4b5563;
        }
        
        .quiz-option {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px 16px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .quiz-option:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .dark .quiz-option {
            background: #4b5563;
            border-color: #6b7280;
        }
        
        .dark .quiz-option:hover {
            border-color: #60a5fa;
            background: #1e40af;
        }
        
        .quiz-option.selected {
            border-color: #3b82f6;
            background: #dbeafe;
        }
        
        .quiz-option.correct {
            border-color: #10b981;
            background: #d1fae5;
        }
        
        .quiz-option.incorrect {
            border-color: #ef4444;
            background: #fee2e2;
        }
        
        .option-letter {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .quiz-option.correct .option-letter {
            background: #10b981;
        }
        
        .quiz-option.incorrect .option-letter {
            background: #ef4444;
        }
        
        .flashcard-container {
            perspective: 1000px;
            margin: 16px 0;
        }
        
        .flashcard {
            width: 100%;
            height: 200px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s ease;
            cursor: pointer;
        }
        
        .flashcard.flipped {
            transform: rotateY(180deg);
        }
        
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .flashcard-front {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }
        
        .flashcard-back {
            background: linear-gradient(135deg, #10b981 0%, #047857 100%);
            color: white;
            transform: rotateY(180deg);
        }
        
        .citation-badge {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #2563eb;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .citation-badge:hover {
            background: #3b82f6;
            color: white;
        }
        
        .nav-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .nav-item.active {
            color: #2563eb;
            transform: scale(1.05);
        }
        
        .nav-item.active::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: #2563eb;
            border-radius: 50%;
        }
        
        .bottom-nav {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.1);
            border-top: 1px solid rgba(229, 231, 235, 0.5);
        }
        
        .dark .bottom-nav {
            background: rgba(31, 41, 55, 0.95);
            border-top-color: rgba(75, 85, 99, 0.5);
        }
        
        .quick-action {
            background: rgba(59, 130, 246, 0.05);
            border: 1px solid rgba(59, 130, 246, 0.1);
            color: #2563eb;
            padding: 10px 14px;
            border-radius: 10px;
            transition: all 0.2s ease;
            text-align: left;
            font-size: 13px;
            font-weight: 500;
        }
        
        .quick-action:hover {
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }
        
        .dark .quick-action {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }
        
        .typing-dots {
            display: inline-flex;
            gap: 4px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #3b82f6;
            animation: typing 1.5s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; transform: scale(0.8); }
            30% { opacity: 1; transform: scale(1); }
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .pdf-item {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .dark .pdf-item {
            background: rgba(55, 65, 81, 0.9);
            border-color: #4b5563;
        }
        
        .pdf-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #3b82f6;
        }
        
        .dark .pdf-item:hover {
            border-color: #60a5fa;
        }
        
        .subject-badge {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            text-transform: capitalize;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 16px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .save-btn {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .save-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }
        
        .save-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-all duration-300">
    <div class="min-h-screen max-w-md mx-auto bg-white dark:bg-gray-800 relative overflow-hidden">
        <!-- Enhanced Header -->
        <header class="glass-card border-0 border-b border-gray-200 dark:border-gray-700 px-4 py-3 sticky top-0 z-30">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-11 h-11 bg-gradient-to-br from-primary-500 to-primary-700 rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-user-md text-white text-sm"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-gray-900 dark:text-white text-sm">MedBot Pro</h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1" id="statusText">
                            <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                            Assistant médical IA
                        </p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="text-right">
                        <div class="text-xs text-gray-400 dark:text-gray-500">Par</div>
                        <div class="text-xs font-semibold text-primary-600 dark:text-primary-400">Oubeida Aryan</div>
                    </div>
                    <button id="menuBtn" class="w-9 h-9 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center hover:scale-105 transition-transform">
                        <i class="fas fa-ellipsis-h text-gray-600 dark:text-gray-400 text-sm"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="pb-20 relative">
            <!-- Upload Section -->
            <div id="uploadSection" class="p-4">
                <div class="text-center mb-6 pt-6">
                    <div class="w-16 h-16 bg-gradient-to-br from-primary-500 to-primary-700 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i class="fas fa-file-medical text-white text-lg"></i>
                    </div>
                    <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Téléchargez votre cours médical</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400">PDF de cours, guides cliniques ou articles médicaux</p>
                </div>

                <div class="glass-card rounded-2xl p-6 border-2 border-dashed border-primary-300 dark:border-primary-600 mb-6">
                    <input type="file" id="pdfInput" accept=".pdf" class="hidden">
                    <div id="uploadArea" class="text-center cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-2xl text-primary-500 mb-3"></i>
                        <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Glissez votre PDF ici</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">ou appuyez pour sélectionner</p>
                        <button id="uploadBtn" class="bg-gradient-to-r from-primary-500 to-primary-700 hover:from-primary-600 hover:to-primary-800 text-white px-6 py-2.5 rounded-lg text-sm font-semibold transition-all transform hover:scale-105 shadow-md">
                            <i class="fas fa-plus mr-2"></i>Choisir un fichier
                        </button>
                    </div>

                    <!-- Subject Selection and Save Button -->
                    <div id="fileControls" class="mt-4 hidden">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Matière</label>
                                <select id="subjectSelect" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm">
                                    <option value="anatomie">Anatomie</option>
                                    <option value="physiologie">Physiologie</option>
                                    <option value="pharmacologie">Pharmacologie</option>
                                    <option value="pathologie">Pathologie</option>
                                    <option value="cardiologie">Cardiologie</option>
                                    <option value="neurologie">Neurologie</option>
                                    <option value="pediatrie">Pédiatrie</option>
                                    <option value="chirurgie">Chirurgie</option>
                                    <option value="gynecologie">Gynécologie</option>
                                    <option value="psychiatrie">Psychiatrie</option>
                                    <option value="autres">Autres</option>
                                </select>
                            </div>
                            <div class="pt-7">
                                <button id="savePdfBtn" class="save-btn" disabled>
                                    <i class="fas fa-save"></i>
                                    Sauvegarder
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="fileInfo" class="mt-4 hidden">
                        <div class="glass-card rounded-xl p-4 border border-gray-200 dark:border-gray-600">
                            <div class="flex items-center space-x-3 mb-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center shadow-md">
                                    <i class="fas fa-file-pdf text-white text-sm"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p id="fileName" class="font-semibold text-gray-900 dark:text-white text-sm truncate"></p>
                                    <p id="fileSize" class="text-xs text-gray-500 dark:text-gray-400"></p>
                                </div>
                            </div>
                            
                            <div id="processingProgress" class="hidden">
                                <div class="flex justify-between text-xs mb-2">
                                    <span class="text-gray-600 dark:text-gray-400">Analyse en cours...</span>
                                    <span id="progressText" class="text-primary-600 dark:text-primary-400 font-semibold">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                    <div id="progressBar" class="bg-gradient-to-r from-primary-500 to-primary-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- My PDFs Library -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-gray-900 dark:text-white text-sm">Ma Bibliothèque PDF</h3>
                        <button id="clearLibraryBtn" class="text-xs text-red-600 hover:text-red-700 transition-colors">
                            <i class="fas fa-trash mr-1"></i>Vider
                        </button>
                    </div>
                    <div id="pdfLibrary" class="space-y-2 max-h-60 overflow-y-auto scrollbar-hide">
                        <div class="text-center py-6 text-gray-500 dark:text-gray-400" id="emptyLibrary">
                            <i class="fas fa-folder-open text-2xl mb-2"></i>
                            <p class="text-xs">Aucun PDF sauvegardé</p>
                        </div>
                    </div>
                </div>

                <!-- Features Grid -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="glass-card rounded-xl p-4 border border-gray-200 dark:border-gray-600 hover:border-primary-300 transition-all">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mb-3">
                            <i class="fas fa-brain text-white text-xs"></i>
                        </div>
                        <h3 class="font-semibold text-gray-900 dark:text-white text-xs mb-1">IA Médicale</h3>
                        <p class="text-xs text-gray-600 dark:text-gray-400">Assistant spécialisé</p>
                    </div>
                    <div class="glass-card rounded-xl p-4 border border-gray-200 dark:border-gray-600 hover:border-green-300 transition-all">
                        <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center mb-3">
                            <i class="fas fa-save text-white text-xs"></i>
                        </div>
                        <h3 class="font-semibold text-gray-900 dark:text-white text-xs mb-1">Sauvegarde PWA</h3>
                        <p class="text-xs text-gray-600 dark:text-gray-400">PDFs organisés</p>
                    </div>
                    <div class="glass-card rounded-xl p-4 border border-gray-200 dark:border-gray-600 hover:border-purple-300 transition-all">
                        <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center mb-3">
                            <i class="fas fa-graduation-cap text-white text-xs"></i>
                        </div>
                        <h3 class="font-semibold text-gray-900 dark:text-white text-xs mb-1">Quiz Interactifs</h3>
                        <p class="text-xs text-gray-600 dark:text-gray-400">Tests intelligents</p>
                    </div>
                    <div class="glass-card rounded-xl p-4 border border-gray-200 dark:border-gray-600 hover:border-orange-300 transition-all">
                        <div class="w-8 h-8 bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg flex items-center justify-center mb-3">
                            <i class="fas fa-clone text-white text-xs"></i>
                        </div>
                        <h3 class="font-semibold text-gray-900 dark:text-white text-xs mb-1">Flashcards</h3>
                        <p class="text-xs text-gray-600 dark:text-gray-400">Mémorisation active</p>
                    </div>
                </div>
            </div>

            <!-- Chat Container -->
            <div id="chatContainer" class="hidden">
                <!-- Quick Actions -->
                <div id="quickActions" class="p-3 border-b border-gray-200 dark:border-gray-700 glass-card border-0">
                    <div class="flex space-x-2 overflow-x-auto scrollbar-hide pb-1">
                        <button class="quick-action whitespace-nowrap" data-action="resume">
                            <i class="fas fa-file-alt mr-1.5"></i>Résumé
                        </button>
                        <button class="quick-action whitespace-nowrap" data-action="quiz">
                            <i class="fas fa-brain mr-1.5"></i>Quiz
                        </button>
                        <button class="quick-action whitespace-nowrap" data-action="flashcards">
                            <i class="fas fa-clone mr-1.5"></i>Flashcards
                        </button>
                        <button class="quick-action whitespace-nowrap" data-action="terminology">
                            <i class="fas fa-book-medical mr-1.5"></i>Terminologie
                        </button>
                    </div>
                </div>

                <!-- Messages Container -->
                <div id="messagesContainer" class="flex-1 overflow-y-auto scrollbar-hide p-3 space-y-4">
                    <!-- Messages will be inserted here -->
                </div>
            </div>

            <!-- Study Panel -->
            <div id="studyPanel" class="hidden p-4">
                <div class="space-y-4">
                    <!-- Study Session Card -->
                    <div class="glass-card rounded-xl p-4 border border-gray-200 dark:border-gray-600">
                        <h3 class="font-bold text-gray-900 dark:text-white mb-3 text-sm">Session d'étude</h3>
                        <div class="grid grid-cols-3 gap-3 text-center">
                            <div class="glass-card rounded-lg p-3">
                                <div class="text-lg font-bold text-gray-900 dark:text-white" id="questionsAnswered">0</div>
                                <div class="text-xs text-gray-500">Questions</div>
                            </div>
                            <div class="glass-card rounded-lg p-3">
                                <div class="text-lg font-bold text-gray-900 dark:text-white" id="studyTime">0min</div>
                                <div class="text-xs text-gray-500">Temps</div>
                            </div>
                            <div class="glass-card rounded-lg p-3">
                                <div class="text-lg font-bold text-gray-900 dark:text-white" id="accuracy">0%</div>
                                <div class="text-xs text-gray-500">Précision</div>
                            </div>
                        </div>
                    </div>

                    <!-- Bookmarks -->
                    <div class="glass-card rounded-xl p-4 border border-gray-200 dark:border-gray-600">
                        <h3 class="font-bold text-gray-900 dark:text-white mb-3 text-sm">Favoris</h3>
                        <div id="bookmarksList" class="space-y-2">
                            <p class="text-gray-500 dark:text-gray-400 text-sm text-center py-4">Aucun favori</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tools Panel -->
            <div id="toolsPanel" class="hidden p-4">
                <div class="space-y-4">
                    <div>
                        <h3 class="font-bold text-gray-900 dark:text-white mb-3 text-sm">Calculateurs Médicaux</h3>
                        <div class="space-y-2">
                            <button class="quick-action w-full flex items-center gap-3" data-tool="bmi">
                                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-weight text-white text-xs"></i>
                                </div>
                                <div class="text-left">
                                    <div class="font-semibold text-xs">Calculateur IMC</div>
                                    <div class="text-xs opacity-70">Indice de masse corporelle</div>
                                </div>
                            </button>
                            <button class="quick-action w-full flex items-center gap-3" data-tool="dosage">
                                <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-pills text-white text-xs"></i>
                                </div>
                                <div class="text-left">
                                    <div class="font-semibold text-xs">Calcul de posologie</div>
                                    <div class="text-xs opacity-70">Dosage personnalisé</div>
                                </div>
                            </button>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-bold text-gray-900 dark:text-white mb-3 text-sm">Paramètres</h3>
                        <div class="space-y-2">
                            <button id="darkModeToggle" class="quick-action w-full flex items-center gap-3">
                                <div class="w-8 h-8 bg-gradient-to-br from-gray-500 to-gray-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-moon text-white text-xs"></i>
                                </div>
                                <div class="text-left">
                                    <div class="font-semibold text-xs">Mode sombre</div>
                                    <div class="text-xs opacity-70">Interface adaptée</div>
                                </div>
                            </button>
                            <button id="exportSession" class="quick-action w-full flex items-center gap-3">
                                <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-download text-white text-xs"></i>
                                </div>
                                <div class="text-left">
                                    <div class="font-semibold text-xs">Exporter session</div>
                                    <div class="text-xs opacity-70">Sauvegarder données</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Chat Input -->
        <div id="chatInput" class="hidden fixed bottom-16 left-0 right-0 max-w-md mx-auto glass-card border-t border-gray-200 dark:border-gray-700 p-3">
            <div class="flex space-x-2">
                <div class="flex-1 relative">
                    <input 
                        type="text" 
                        id="messageInput" 
                        placeholder="Posez votre question médicale..." 
                        class="w-full px-3 py-3 pr-12 bg-gray-100 dark:bg-gray-700 border-0 rounded-xl focus:ring-2 focus:ring-primary-500 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 transition-all text-sm"
                    >
                    <button id="voiceBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 w-8 h-8 rounded-lg bg-gray-200 dark:bg-gray-600 flex items-center justify-center transition-transform hover:scale-105">
                        <i class="fas fa-microphone text-gray-600 dark:text-gray-400 text-xs"></i>
                    </button>
                </div>
                <button id="sendBtn" class="w-12 h-12 bg-gradient-to-br from-primary-500 to-primary-700 hover:from-primary-600 hover:to-primary-800 text-white rounded-xl flex items-center justify-center transition-all transform hover:scale-105 shadow-md">
                    <i class="fas fa-paper-plane text-sm"></i>
                </button>
            </div>
            <div id="voiceIndicator" class="hidden flex items-center justify-center space-x-2 mt-2 text-red-500 text-xs">
                <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                <span>Écoute en cours...</span>
            </div>
        </div>

        <!-- Enhanced Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bottom-nav">
            <div class="flex">
                <button class="nav-item flex-1 flex flex-col items-center py-3 active" data-tab="chat">
                    <i class="fas fa-comments text-lg mb-1"></i>
                    <span class="text-xs font-medium">Chat</span>
                </button>
                <button class="nav-item flex-1 flex flex-col items-center py-3 text-gray-400 dark:text-gray-500" data-tab="study">
                    <i class="fas fa-graduation-cap text-lg mb-1"></i>
                    <span class="text-xs font-medium">Étude</span>
                </button>
                <button class="nav-item flex-1 flex flex-col items-center py-3 text-gray-400 dark:text-gray-500" data-tab="tools">
                    <i class="fas fa-tools text-lg mb-1"></i>
                    <span class="text-xs font-medium">Outils</span>
                </button>
            </div>
        </nav>

        <!-- Menu Modal -->
        <div id="menuModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden backdrop-blur-sm">
            <div class="absolute bottom-0 left-0 right-0 glass-card rounded-t-2xl p-4 max-w-md mx-auto slide-in">
                <div class="w-8 h-1 bg-gray-300 dark:bg-gray-600 rounded-full mx-auto mb-4"></div>
                <div class="space-y-3">
                    <button class="w-full text-left p-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl transition-all flex items-center gap-3" id="toggleDarkMode">
                        <div class="w-10 h-10 bg-gradient-to-br from-gray-500 to-gray-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-moon text-white text-sm"></i>
                        </div>
                        <div>
                            <div class="font-semibold text-gray-900 dark:text-white text-sm">Mode sombre</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Interface adaptée</div>
                        </div>
                    </button>
                    <button class="w-full text-left p-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl transition-all flex items-center gap-3" id="exportData">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-download text-white text-sm"></i>
                        </div>
                        <div>
                            <div class="font-semibold text-gray-900 dark:text-white text-sm">Exporter données</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Sauvegarder progression</div>
                        </div>
                    </button>
                    <button class="w-full text-left p-3 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-all flex items-center gap-3 text-red-600" id="resetData">
                        <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-red-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-trash text-white text-sm"></i>
                        </div>
                        <div>
                            <div class="font-semibold">Réinitialiser</div>
                            <div class="text-xs opacity-70">Effacer toutes les données</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Notification Container -->
        <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
    </div>

    <script>
        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'medbot-pro-v1';
                const urlsToCache = [
                    '/',
                    '/index.html'
                ];

                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => cache.addAll(urlsToCache))
                    );
                });

                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => {
                                if (response) {
                                    return response;
                                }
                                return fetch(event.request);
                            })
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl)
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed:', err));
        }

        // Dark mode management
        let isDarkMode = localStorage.getItem('darkMode') === 'true' || 
            (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches);

        function updateDarkMode() {
            document.documentElement.classList.toggle('dark', isDarkMode);
            localStorage.setItem('darkMode', isDarkMode);
            
            const moonIcons = document.querySelectorAll('.fa-moon');
            moonIcons.forEach(icon => {
                if (isDarkMode) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                }
            });
        }

        updateDarkMode();

        // Notification system
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} text-sm"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.getElementById('notificationContainer').appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // PDF Storage Manager with better error handling
        class PDFStorage {
            constructor() {
                this.dbName = 'MedBotPDFs';
                this.version = 1;
                this.db = null;
                this.isReady = false;
            }

            async init() {
                if (this.isReady) return Promise.resolve();
                
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onerror = () => {
                        console.error('IndexedDB error:', request.error);
                        reject(request.error);
                    };
                    
                    request.onsuccess = () => {
                        this.db = request.result;
                        this.isReady = true;
                        resolve();
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('pdfs')) {
                            const store = db.createObjectStore('pdfs', { keyPath: 'id', autoIncrement: true });
                            store.createIndex('subject', 'subject', { unique: false });
                            store.createIndex('name', 'name', { unique: false });
                            store.createIndex('uploadDate', 'uploadDate', { unique: false });
                        }
                    };
                });
            }

            async savePDF(name, subject, content, text, pages) {
                await this.init();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['pdfs'], 'readwrite');
                    const store = transaction.objectStore('pdfs');
                    
                    const pdf = {
                        name: name,
                        subject: subject,
                        content: Array.from(new Uint8Array(content)),
                        text: text,
                        pages: pages,
                        uploadDate: new Date().toISOString(),
                        size: content.byteLength
                    };
                    
                    const request = store.add(pdf);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAllPDFs() {
                await this.init();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['pdfs'], 'readonly');
                    const store = transaction.objectStore('pdfs');
                    
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async deletePDF(id) {
                await this.init();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['pdfs'], 'readwrite');
                    const store = transaction.objectStore('pdfs');
                    
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async clearAll() {
                await this.init();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['pdfs'], 'readwrite');
                    const store = transaction.objectStore('pdfs');
                    
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        }

        class MedBotPro {
            constructor() {
                this.apiKey = 'AIzaSyBPcqTGnnjcgYCd_kcfEbL_PgnuVakPaOY';
                this.pdfText = '';
                this.pdfPages = [];
                this.isProcessing = false;
                this.chatHistory = [];
                this.bookmarks = [];
                this.studyStats = { 
                    questionsAnswered: 0, 
                    correctAnswers: 0,
                    studyTime: 0, 
                    startTime: null
                };
                this.currentTab = 'chat';
                this.isListening = false;
                this.pdfStorage = new PDFStorage();
                this.currentPDF = null;
                this.currentFileData = null;
                
                this.initializeElements();
                this.setupEventListeners();
                this.initializeSpeechRecognition();
                this.showTab('chat');
                this.loadPDFLibrary();
            }

            initializeElements() {
                this.elements = {
                    uploadSection: document.getElementById('uploadSection'),
                    chatContainer: document.getElementById('chatContainer'),
                    toolsPanel: document.getElementById('toolsPanel'),
                    studyPanel: document.getElementById('studyPanel'),
                    messagesContainer: document.getElementById('messagesContainer'),
                    chatInput: document.getElementById('chatInput'),
                    
                    pdfInput: document.getElementById('pdfInput'),
                    uploadArea: document.getElementById('uploadArea'),
                    uploadBtn: document.getElementById('uploadBtn'),
                    fileControls: document.getElementById('fileControls'),
                    subjectSelect: document.getElementById('subjectSelect'),
                    savePdfBtn: document.getElementById('savePdfBtn'),
                    fileInfo: document.getElementById('fileInfo'),
                    fileName: document.getElementById('fileName'),
                    fileSize: document.getElementById('fileSize'),
                    processingProgress: document.getElementById('processingProgress'),
                    progressBar: document.getElementById('progressBar'),
                    progressText: document.getElementById('progressText'),
                    pdfLibrary: document.getElementById('pdfLibrary'),
                    emptyLibrary: document.getElementById('emptyLibrary'),
                    clearLibraryBtn: document.getElementById('clearLibraryBtn'),
                    
                    messageInput: document.getElementById('messageInput'),
                    sendBtn: document.getElementById('sendBtn'),
                    voiceBtn: document.getElementById('voiceBtn'),
                    voiceIndicator: document.getElementById('voiceIndicator'),
                    
                    statusText: document.getElementById('statusText'),
                    questionsAnswered: document.getElementById('questionsAnswered'),
                    studyTime: document.getElementById('studyTime'),
                    accuracy: document.getElementById('accuracy'),
                    bookmarksList: document.getElementById('bookmarksList'),
                    
                    menuBtn: document.getElementById('menuBtn'),
                    menuModal: document.getElementById('menuModal'),
                    darkModeToggle: document.getElementById('darkModeToggle'),
                    toggleDarkMode: document.getElementById('toggleDarkMode'),
                    exportSession: document.getElementById('exportSession'),
                    exportData: document.getElementById('exportData'),
                    resetData: document.getElementById('resetData')
                };
            }

            setupEventListeners() {
                // Navigation with smooth transitions
                document.querySelectorAll('.nav-item').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const tab = e.currentTarget.dataset.tab;
                        this.showTab(tab);
                    });
                });

                // Upload handlers
                this.elements.uploadBtn?.addEventListener('click', () => this.elements.pdfInput?.click());
                this.elements.uploadArea?.addEventListener('click', () => this.elements.pdfInput?.click());
                this.elements.pdfInput?.addEventListener('change', (e) => this.handlePDFUpload(e));
                this.elements.savePdfBtn?.addEventListener('click', () => this.savePDFToLibrary());
                this.elements.clearLibraryBtn?.addEventListener('click', () => this.clearLibrary());
                
                // Chat handlers
                this.elements.sendBtn?.addEventListener('click', () => this.sendMessage());
                this.elements.voiceBtn?.addEventListener('click', () => this.toggleVoiceInput());
                this.elements.messageInput?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !this.isProcessing) this.sendMessage();
                });
                
                // Menu handlers
                this.elements.menuBtn?.addEventListener('click', () => this.toggleMenu());
                this.elements.menuModal?.addEventListener('click', (e) => {
                    if (e.target === this.elements.menuModal) this.toggleMenu();
                });
                
                // Settings handlers
                [this.elements.darkModeToggle, this.elements.toggleDarkMode].forEach(btn => {
                    btn?.addEventListener('click', () => this.toggleDarkMode());
                });
                
                [this.elements.exportSession, this.elements.exportData].forEach(btn => {
                    btn?.addEventListener('click', () => this.exportSession());
                });
                
                this.elements.resetData?.addEventListener('click', () => this.resetApp());
                
                // Quick actions
                document.querySelectorAll('[data-action]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const action = e.target.closest('[data-action]')?.dataset.action;
                        if (action) this.handleQuickAction(action);
                    });
                });
                
                // Tools
                document.querySelectorAll('[data-tool]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const tool = e.target.closest('[data-tool]')?.dataset.tool;
                        if (tool) this.handleTool(tool);
                    });
                });
                
                this.setupDragDrop();
            }

            async loadPDFLibrary() {
                try {
                    const pdfs = await this.pdfStorage.getAllPDFs();
                    this.displayPDFLibrary(pdfs);
                } catch (error) {
                    console.error('Error loading PDF library:', error);
                    showNotification('Erreur lors du chargement de la bibliothèque', 'error');
                }
            }

            displayPDFLibrary(pdfs) {
                if (pdfs.length === 0) {
                    this.elements.pdfLibrary.innerHTML = `
                        <div class="text-center py-6 text-gray-500 dark:text-gray-400" id="emptyLibrary">
                            <i class="fas fa-folder-open text-2xl mb-2"></i>
                            <p class="text-xs">Aucun PDF sauvegardé</p>
                        </div>
                    `;
                    return;
                }

                this.elements.pdfLibrary.innerHTML = pdfs.map(pdf => `
                    <div class="pdf-item" data-pdf-id="${pdf.id}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3 flex-1 min-w-0">
                                <div class="w-8 h-8 bg-gradient-to-br from-primary-500 to-primary-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-file-pdf text-white text-xs"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="font-semibold text-gray-900 dark:text-white text-sm truncate">${pdf.name}</p>
                                    <div class="flex items-center space-x-2 mt-1">
                                        <span class="subject-badge">${pdf.subject}</span>
                                        <span class="text-xs text-gray-500">${this.formatFileSize(pdf.size)}</span>
                                    </div>
                                </div>
                            </div>
                            <button class="text-red-500 hover:text-red-700 p-1 transition-colors" onclick="medBot.deletePDF(${pdf.id})">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>
                `).join('');

                // Add click handlers for loading PDFs
                document.querySelectorAll('.pdf-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) {
                            const pdfId = parseInt(item.dataset.pdfId);
                            this.loadPDF(pdfId);
                        }
                    });
                });
            }

            async loadPDF(id) {
                try {
                    const pdfs = await this.pdfStorage.getAllPDFs();
                    const pdf = pdfs.find(p => p.id === id);
                    
                    if (pdf) {
                        this.currentPDF = pdf;
                        this.pdfText = pdf.text;
                        this.pdfPages = pdf.pages;
                        
                        this.elements.statusText.innerHTML = `
                            <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                            ${pdf.name} chargé
                        `;
                        
                        this.showChatInterface();
                        showNotification(`PDF "${pdf.name}" chargé avec succès!`);
                    }
                } catch (error) {
                    console.error('Error loading PDF:', error);
                    showNotification('Erreur lors du chargement du PDF', 'error');
                }
            }

            async deletePDF(id) {
                if (confirm('Supprimer ce PDF de votre bibliothèque ?')) {
                    try {
                        await this.pdfStorage.deletePDF(id);
                        this.loadPDFLibrary();
                        showNotification('PDF supprimé');
                    } catch (error) {
                        console.error('Error deleting PDF:', error);
                        showNotification('Erreur lors de la suppression', 'error');
                    }
                }
            }

            async clearLibrary() {
                if (confirm('Vider complètement votre bibliothèque PDF ?')) {
                    try {
                        await this.pdfStorage.clearAll();
                        this.loadPDFLibrary();
                        showNotification('Bibliothèque vidée');
                    } catch (error) {
                        console.error('Error clearing library:', error);
                        showNotification('Erreur lors du vidage', 'error');
                    }
                }
            }

            showTab(tabName) {
                this.currentTab = tabName;
                
                // Update navigation with smooth transitions
                document.querySelectorAll('.nav-item').forEach(btn => {
                    btn.classList.remove('active');
                    btn.classList.add('text-gray-400', 'dark:text-gray-500');
                });
                
                const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                    activeBtn.classList.remove('text-gray-400', 'dark:text-gray-500');
                }
                
                // Hide all sections with fade out
                const sections = [this.elements.uploadSection, this.elements.chatContainer, this.elements.toolsPanel, this.elements.studyPanel];
                sections.forEach(section => {
                    if (section && !section.classList.contains('hidden')) {
                        section.style.opacity = '0';
                        setTimeout(() => section.classList.add('hidden'), 150);
                    }
                });
                
                // Show target section with fade in
                setTimeout(() => {
                    if (tabName === 'chat') {
                        if (this.pdfText) {
                            this.elements.chatContainer?.classList.remove('hidden');
                            this.elements.chatInput?.classList.remove('hidden');
                        } else {
                            this.elements.uploadSection?.classList.remove('hidden');
                            this.elements.chatInput?.classList.add('hidden');
                        }
                    } else if (tabName === 'tools') {
                        this.elements.toolsPanel?.classList.remove('hidden');
                        this.elements.chatInput?.classList.add('hidden');
                    } else if (tabName === 'study') {
                        this.elements.studyPanel?.classList.remove('hidden');
                        this.elements.chatInput?.classList.add('hidden');
                        this.updateStudyDisplay();
                    }
                    
                    // Fade in the new section
                    const activeSection = document.querySelector('main > div:not(.hidden)');
                    if (activeSection) {
                        activeSection.style.opacity = '0';
                        activeSection.offsetHeight; // Force reflow
                        activeSection.style.transition = 'opacity 0.3s ease';
                        activeSection.style.opacity = '1';
                    }
                }, 150);
            }

            toggleMenu() {
                this.elements.menuModal?.classList.toggle('hidden');
            }

            setupDragDrop() {
                const uploadArea = this.elements.uploadArea;
                if (!uploadArea) return;
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, this.preventDefaults, false);
                });
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, () => {
                        uploadArea.classList.add('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20');
                    });
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, () => {
                        uploadArea.classList.remove('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20');
                    });
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    const files = e.dataTransfer.files;
                    if (files.length > 0 && files[0].type === 'application/pdf') {
                        this.elements.pdfInput.files = files;
                        this.handlePDFUpload({ target: { files } });
                    }
                });
            }

            preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            initializeSpeechRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.lang = 'fr-FR';
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;

                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        this.elements.messageInput.value = transcript;
                        this.stopVoiceInput();
                        showNotification('Transcription terminée!');
                    };

                    this.recognition.onerror = () => {
                        this.stopVoiceInput();
                        showNotification('Erreur de reconnaissance vocale', 'error');
                    };
                    
                    this.recognition.onend = () => this.stopVoiceInput();
                } else if (this.elements.voiceBtn) {
                    this.elements.voiceBtn.style.display = 'none';
                }
            }

            toggleVoiceInput() {
                if (!this.recognition) return;
                this.isListening ? this.stopVoiceInput() : this.startVoiceInput();
            }

            startVoiceInput() {
                this.isListening = true;
                this.elements.voiceIndicator?.classList.remove('hidden');
                this.elements.voiceBtn.innerHTML = '<i class="fas fa-stop text-red-500 text-xs"></i>';
                this.recognition.start();
                showNotification('Écoute activée...');
            }

            stopVoiceInput() {
                this.isListening = false;
                this.elements.voiceIndicator?.classList.add('hidden');
                this.elements.voiceBtn.innerHTML = '<i class="fas fa-microphone text-gray-600 dark:text-gray-400 text-xs"></i>';
                if (this.recognition) this.recognition.stop();
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Octets';
                const k = 1024;
                const sizes = ['Octets', 'Ko', 'Mo', 'Go'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            async handlePDFUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.elements.fileName.textContent = file.name;
                this.elements.fileSize.textContent = this.formatFileSize(file.size);
                this.elements.fileInfo?.classList.remove('hidden');
                this.elements.fileControls?.classList.remove('hidden');
                this.elements.processingProgress?.classList.remove('hidden');

                try {
                    const arrayBuffer = await file.arrayBuffer();
                    this.currentFileData = { name: file.name, arrayBuffer, size: file.size };
                    
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    
                    this.pdfPages = [];
                    let fullText = '';
                    const totalPages = pdf.numPages;

                    for (let i = 1; i <= totalPages; i++) {
                        const progress = (i / totalPages) * 100;
                        this.elements.progressBar.style.width = `${progress}%`;
                        this.elements.progressText.textContent = `${Math.round(progress)}%`;

                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items
                            .map(item => item.str)
                            .join(' ')
                            .replace(/\s+/g, ' ')
                            .trim();
                        
                        if (pageText) {
                            this.pdfPages.push({
                                pageNumber: i,
                                text: pageText
                            });
                            fullText += `\n\n--- Page ${i} ---\n${pageText}`;
                        }

                        await new Promise(resolve => setTimeout(resolve, 50));
                    }

                    this.pdfText = fullText;
                    this.currentFileData.text = fullText;
                    this.currentFileData.pages = this.pdfPages;
                    
                    // Enable save button
                    this.elements.savePdfBtn.disabled = false;
                    
                    this.elements.statusText.innerHTML = `
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                        ${totalPages} pages analysées
                    `;
                    
                    showNotification('PDF analysé ! Cliquez sur "Sauvegarder" pour l\'ajouter à votre bibliothèque.');
                } catch (error) {
                    console.error('Erreur PDF:', error);
                    this.showError('Erreur lors du traitement du PDF');
                    this.elements.processingProgress?.classList.add('hidden');
                    showNotification('Erreur lors du traitement du PDF', 'error');
                }
            }

            async savePDFToLibrary() {
                if (!this.currentFileData) {
                    showNotification('Aucun fichier à sauvegarder', 'error');
                    return;
                }

                try {
                    this.elements.savePdfBtn.disabled = true;
                    this.elements.savePdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sauvegarde...';

                    const subject = this.elements.subjectSelect.value;
                    
                    await this.pdfStorage.savePDF(
                        this.currentFileData.name,
                        subject,
                        this.currentFileData.arrayBuffer,
                        this.currentFileData.text,
                        this.currentFileData.pages
                    );
                    
                    this.loadPDFLibrary();
                    this.showChatInterface();
                    showNotification('PDF sauvegardé dans votre bibliothèque !');
                    
                    // Reset UI
                    this.elements.fileControls?.classList.add('hidden');
                    this.elements.processingProgress?.classList.add('hidden');
                    this.elements.pdfInput.value = '';
                    
                } catch (error) {
                    console.error('Error saving PDF:', error);
                    showNotification('Erreur lors de la sauvegarde', 'error');
                } finally {
                    this.elements.savePdfBtn.disabled = false;
                    this.elements.savePdfBtn.innerHTML = '<i class="fas fa-save"></i> Sauvegarder';
                }
            }

            showChatInterface() {
                this.showTab('chat');
                this.startStudySession();
                
                setTimeout(() => {
                    this.addMessage('🩺 **Bonjour ! Je suis MedBot Pro, votre assistant médical IA.**\n\n✅ **Document analysé avec succès !**\n\n💬 Posez-moi vos questions sur le contenu\n🧠 Générez des quiz personnalisés\n📚 Créez des flashcards pour mémoriser\n📊 Suivez votre progression d\'apprentissage\n\n**Comment puis-je vous aider dans vos études médicales ?**', 'bot');
                }, 500);
            }

            async sendMessage() {
                const message = this.elements.messageInput?.value.trim();
                if (!message || !this.pdfText || this.isProcessing) return;

                this.elements.messageInput.value = '';
                this.isProcessing = true;
                this.elements.sendBtn.disabled = true;
                this.elements.sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-sm"></i>';
                
                this.addMessage(message, 'user');
                this.showTypingIndicator();

                try {
                    const response = await this.queryGemini(message);
                    this.removeTypingIndicator();
                    this.addMessage(response.text, 'bot', response.citations);
                    
                    this.chatHistory.push({
                        question: message,
                        answer: response.text,
                        timestamp: new Date().toISOString()
                    });
                    
                    this.updateStudyProgress();
                    showNotification('Réponse reçue!');
                } catch (error) {
                    console.error('Erreur API:', error);
                    this.removeTypingIndicator();
                    this.addMessage('❌ **Erreur de connexion**\n\nImpossible de traiter votre demande. Veuillez réessayer.', 'bot');
                    showNotification('Erreur de connexion', 'error');
                } finally {
                    this.isProcessing = false;
                    this.elements.sendBtn.disabled = false;
                    this.elements.sendBtn.innerHTML = '<i class="fas fa-paper-plane text-sm"></i>';
                }
            }

            async queryGemini(question) {
                const prompt = `Tu es MedBot Pro, un assistant médical IA expert développé par Oubeida Aryan. Réponds UNIQUEMENT en français en utilisant EXCLUSIVEMENT le contenu du PDF médical fourni.

Instructions pour les formats :

POUR LES QUIZ - Format EXACT requis :
🧠 **QUIZ MÉDICAL INTERACTIF**

**Question 1:** [Votre question ici]
A) [Option A]
B) [Option B]
C) [Option C]  
D) [Option D]
**Réponse correcte: A** ✅
**Explication:** [Explication détaillée avec citation]

POUR LES FLASHCARDS - Format EXACT requis :
📚 **FLASHCARDS MÉDICALES**

**CARD:** [Terme médical ou question]
**ANSWER:** [Définition ou réponse détaillée]

RÈGLES GÉNÉRALES :
1. Utilise des émojis médicaux appropriés (🩺💊🫀🧠📊⚕️)
2. Inclus TOUJOURS des citations [Page X] pour chaque information
3. Sois concis et précis dans tes réponses
4. Structure tes réponses de manière claire
5. Explique les termes médicaux complexes

Contenu du PDF médical :
${this.pdfText}

Question de l'utilisateur : ${question}`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            temperature: 0.2,
                            maxOutputTokens: 2000
                        }
                    })
                });

                if (!response.ok) throw new Error(`Erreur API: ${response.status}`);

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                const citations = this.extractCitations(text);

                return { text, citations };
            }

            extractCitations(text) {
                const citationPattern = /\[Page (\d+)\]/g;
                const citations = new Set();
                let match;

                while ((match = citationPattern.exec(text)) !== null) {
                    const pageNum = parseInt(match[1]);
                    if (pageNum <= this.pdfPages.length) {
                        citations.add(pageNum);
                    }
                }

                return Array.from(citations).sort((a, b) => a - b);
            }

            addMessage(text, sender, citations = []) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} fade-in`;

                if (sender === 'bot' && (text.includes('🧠 **QUIZ MÉDICAL') || text.includes('**Question 1:**'))) {
                    this.createQuizMessage(messageDiv, text, citations);
                } else if (sender === 'bot' && (text.includes('📚 **FLASHCARDS MÉDICALES**') || text.includes('**CARD:**'))) {
                    this.createFlashcardsMessage(messageDiv, text, citations);
                } else {
                    this.createRegularMessage(messageDiv, text, sender, citations);
                }

                this.elements.messagesContainer?.appendChild(messageDiv);
                this.elements.messagesContainer.scrollTop = this.elements.messagesContainer.scrollHeight;
            }

            createQuizMessage(messageDiv, text, citations) {
                const quizContainer = document.createElement('div');
                quizContainer.className = 'w-full max-w-full';
                
                const quizElement = document.createElement('div');
                quizElement.className = 'quiz-container';
                
                const header = document.createElement('div');
                header.className = 'text-center mb-4';
                header.innerHTML = `
                    <div class="flex items-center justify-center gap-2 mb-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-brain text-white text-sm"></i>
                        </div>
                        <h3 class="font-bold text-purple-700 dark:text-purple-300 text-sm">Quiz Médical Interactif</h3>
                    </div>
                `;
                quizElement.appendChild(header);
                
                const questions = this.parseQuizQuestions(text);
                questions.forEach((q, index) => {
                    const questionElement = this.createQuizQuestion(q, index);
                    quizElement.appendChild(questionElement);
                });

                if (citations.length > 0) {
                    const citationsDiv = this.createCitationsDiv(citations);
                    quizElement.appendChild(citationsDiv);
                }

                quizContainer.appendChild(quizElement);
                messageDiv.appendChild(quizContainer);
            }

            parseQuizQuestions(text) {
                const questions = [];
                const questionPattern = /\*\*Question (\d+):\*\*\s*(.*?)\n([A-D]\).*?)\n([A-D]\).*?)\n([A-D]\).*?)\n([A-D]\).*?)\n\*\*Réponse correcte:\s*([A-D])\*\*[^*]*\*\*Explication:\*\*\s*(.*?)(?=\*\*Question|\*\*CARD:|$)/gs;
                
                let match;
                while ((match = questionPattern.exec(text)) !== null) {
                    questions.push({
                        number: match[1],
                        question: match[2].trim(),
                        options: [
                            match[3].trim(),
                            match[4].trim(),
                            match[5].trim(),
                            match[6].trim()
                        ],
                        correct: match[7].trim(),
                        explanation: match[8].trim()
                    });
                }
                
                return questions;
            }

            createQuizQuestion(questionData, index) {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'quiz-question';
                
                questionDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex items-start gap-3 mb-4">
                            <div class="w-6 h-6 bg-purple-500 text-white rounded-full flex items-center justify-center font-bold text-xs flex-shrink-0">
                                ${questionData.number}
                            </div>
                            <p class="font-medium text-gray-900 dark:text-white text-sm leading-relaxed">${questionData.question}</p>
                        </div>
                        
                        <div class="space-y-2" data-question="${index}">
                            ${questionData.options.map((option, optIndex) => {
                                const letter = String.fromCharCode(65 + optIndex);
                                return `
                                    <div class="quiz-option" data-option="${letter}" data-question="${index}">
                                        <div class="option-letter">${letter}</div>
                                        <span class="text-sm">${option.replace(/^[A-D]\)\s*/, '')}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="hidden mt-4 p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg" id="explanation-${index}">
                            <div class="flex items-start gap-2">
                                <i class="fas fa-lightbulb text-green-600 mt-1"></i>
                                <div>
                                    <p class="font-medium text-green-700 dark:text-green-300 text-xs mb-1">Réponse correcte : ${questionData.correct}</p>
                                    <p class="text-sm text-gray-700 dark:text-gray-300">${questionData.explanation}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const options = questionDiv.querySelectorAll('.quiz-option');
                options.forEach(option => {
                    option.addEventListener('click', () => {
                        const questionIndex = option.dataset.question;
                        const selectedOption = option.dataset.option;
                        const correctAnswer = questionData.correct;
                        const isCorrect = selectedOption === correctAnswer;
                        
                        const questionContainer = questionDiv.querySelector(`[data-question="${questionIndex}"]`);
                        questionContainer.querySelectorAll('.quiz-option').forEach(opt => {
                            opt.classList.remove('selected', 'correct', 'incorrect');
                            opt.style.pointerEvents = 'none';
                        });
                        
                        option.classList.add('selected');
                        
                        setTimeout(() => {
                            options.forEach(opt => {
                                const optionLetter = opt.dataset.option;
                                if (optionLetter === correctAnswer) {
                                    opt.classList.add('correct');
                                } else if (optionLetter === selectedOption && selectedOption !== correctAnswer) {
                                    opt.classList.add('incorrect');
                                }
                            });
                            
                            document.getElementById(`explanation-${questionIndex}`).classList.remove('hidden');
                            this.updateQuizStats(isCorrect);
                            showNotification(isCorrect ? '✅ Bonne réponse!' : '❌ Réponse incorrecte', isCorrect ? 'success' : 'error');
                        }, 300);
                    });
                });

                return questionDiv;
            }

            createFlashcardsMessage(messageDiv, text, citations) {
                const flashcardsContainer = document.createElement('div');
                flashcardsContainer.className = 'w-full max-w-full';
                
                const flashcardsElement = document.createElement('div');
                flashcardsElement.className = 'bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 border border-green-200 dark:border-green-800 rounded-xl p-4';
                
                const header = document.createElement('div');
                header.className = 'text-center mb-4';
                header.innerHTML = `
                    <div class="flex items-center justify-center gap-2 mb-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-clone text-white text-sm"></i>
                        </div>
                        <h3 class="font-bold text-green-700 dark:text-green-300 text-sm">Flashcards Médicales</h3>
                    </div>
                    <p class="text-xs text-green-600 dark:text-green-400">Cliquez pour retourner les cartes</p>
                `;
                flashcardsElement.appendChild(header);
                
                const flashcards = this.parseFlashcards(text);
                flashcards.forEach((card, index) => {
                    const cardElement = this.createFlashcard(card, index);
                    flashcardsElement.appendChild(cardElement);
                });

                if (citations.length > 0) {
                    const citationsDiv = this.createCitationsDiv(citations);
                    flashcardsElement.appendChild(citationsDiv);
                }

                flashcardsContainer.appendChild(flashcardsElement);
                messageDiv.appendChild(flashcardsContainer);
            }

            parseFlashcards(text) {
                const flashcards = [];
                const cardPattern = /\*\*CARD:\*\*\s*(.*?)\n\*\*ANSWER:\*\*\s*(.*?)(?=\*\*CARD:|\*\*Question:|$)/gs;
                
                let match;
                while ((match = cardPattern.exec(text)) !== null) {
                    flashcards.push({
                        front: match[1].trim(),
                        back: match[2].trim()
                    });
                }
                
                return flashcards;
            }

            createFlashcard(cardData, index) {
                const cardContainer = document.createElement('div');
                cardContainer.className = 'flashcard-container';
                
                cardContainer.innerHTML = `
                    <div class="flashcard" id="flashcard-${index}">
                        <div class="flashcard-face flashcard-front">
                            <div class="text-center">
                                <i class="fas fa-question-circle text-2xl mb-3 opacity-80"></i>
                                <div class="text-sm font-semibold">${cardData.front}</div>
                                <div class="mt-3 text-xs opacity-75">Cliquez pour voir la réponse</div>
                            </div>
                        </div>
                        <div class="flashcard-face flashcard-back">
                            <div class="text-center">
                                <i class="fas fa-lightbulb text-2xl mb-3 opacity-80"></i>
                                <div class="text-sm font-semibold">${cardData.back}</div>
                                <div class="mt-3 text-xs opacity-75">Cliquez pour retourner</div>
                            </div>
                        </div>
                    </div>
                `;

                const flashcard = cardContainer.querySelector('.flashcard');
                flashcard.addEventListener('click', () => {
                    flashcard.classList.toggle('flipped');
                });

                return cardContainer;
            }

            createRegularMessage(messageDiv, text, sender, citations) {
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = `chat-bubble px-4 py-3 ${sender === 'user' ? 'user-bubble' : 'bot-bubble'}`;

                const textDiv = document.createElement('div');
                textDiv.className = 'text-sm leading-relaxed';
                textDiv.innerHTML = this.formatMessage(text);
                bubbleDiv.appendChild(textDiv);

                if (citations.length > 0 && sender === 'bot') {
                    const citationsDiv = this.createCitationsDiv(citations);
                    bubbleDiv.appendChild(citationsDiv);
                }

                if (sender === 'bot') {
                    const bookmarkBtn = document.createElement('button');
                    bookmarkBtn.className = 'mt-2 text-xs text-primary-600 hover:text-primary-700 font-medium transition-colors';
                    bookmarkBtn.innerHTML = '<i class="fas fa-bookmark mr-1"></i>Sauvegarder';
                    bookmarkBtn.onclick = () => this.addBookmark(text, citations);
                    bubbleDiv.appendChild(bookmarkBtn);
                }

                messageDiv.appendChild(bubbleDiv);
            }

            createCitationsDiv(citations) {
                const citationsDiv = document.createElement('div');
                citationsDiv.className = 'mt-3 pt-3 border-t border-gray-200 dark:border-gray-600';
                
                const citationsContainer = document.createElement('div');
                citationsContainer.className = 'flex flex-wrap gap-1';

                citations.forEach(pageNum => {
                    const badge = document.createElement('span');
                    badge.className = 'citation-badge';
                    badge.innerHTML = `Page ${pageNum}`;
                    badge.onclick = () => this.showPagePreview(pageNum);
                    citationsContainer.appendChild(badge);
                });

                citationsDiv.appendChild(citationsContainer);
                return citationsDiv;
            }

            formatMessage(text) {
                return text
                    .replace(/\*\*(.*?)\*\*/g, '<strong class="text-gray-900 dark:text-white font-semibold">$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em class="text-gray-700 dark:text-gray-300">$1</em>')
                    .replace(/^• /gm, '<span class="text-primary-500 font-bold">•</span> ')
                    .replace(/^(\d+\.)/gm, '<span class="font-semibold text-primary-600 dark:text-primary-400">$1</span>');
            }

            showPagePreview(pageNum) {
                const page = this.pdfPages.find(p => p.pageNumber === pageNum);
                if (page) {
                    const preview = page.text.substring(0, 200) + '...';
                    this.addMessage(`📄 **Page ${pageNum} :**\n\n"${preview}"`, 'bot');
                }
            }

            showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.id = 'typingIndicator';
                typingDiv.className = 'flex justify-start fade-in';

                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'bot-bubble px-4 py-3';

                const dotsDiv = document.createElement('div');
                dotsDiv.className = 'flex items-center space-x-2';
                
                const text = document.createElement('span');
                text.textContent = 'Analyse...';
                text.className = 'text-xs text-gray-500';
                dotsDiv.appendChild(text);

                const dotsContainer = document.createElement('div');
                dotsContainer.className = 'typing-dots';
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'typing-dot';
                    dotsContainer.appendChild(dot);
                }
                dotsDiv.appendChild(dotsContainer);

                bubbleDiv.appendChild(dotsDiv);
                typingDiv.appendChild(bubbleDiv);
                this.elements.messagesContainer?.appendChild(typingDiv);
                this.elements.messagesContainer.scrollTop = this.elements.messagesContainer.scrollHeight;
            }

            removeTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.style.opacity = '0';
                    setTimeout(() => indicator.remove(), 300);
                }
            }

            handleQuickAction(action) {
                const actions = {
                    'resume': 'Fais-moi un résumé structuré de ce document médical.',
                    'quiz': 'Génère un quiz médical de 5 questions QCM. Format: 🧠 **QUIZ MÉDICAL INTERACTIF** puis **Question 1:** etc.',
                    'flashcards': 'Crée des flashcards médicales. Format: 📚 **FLASHCARDS MÉDICALES** puis **CARD:** et **ANSWER:**',
                    'terminology': 'Explique les termes médicaux complexes de ce document.'
                };

                if (actions[action]) {
                    this.elements.messageInput.value = actions[action];
                    this.sendMessage();
                }
            }

            handleTool(tool) {
                const tools = {
                    'bmi': () => this.addMessage('🧮 **Calculateur IMC**\n\nFormule : Poids (kg) ÷ Taille² (m)\n\nDonnez-moi le poids et la taille.', 'bot'),
                    'dosage': () => this.addMessage('💊 **Calcul de posologie**\n\nIndiquez :\n• Médicament\n• Poids du patient\n• Indication', 'bot')
                };

                if (tools[tool]) tools[tool]();
            }

            startStudySession() {
                this.studyStats.startTime = Date.now();
                this.updateStudyTimer();
            }

            updateStudyProgress() {
                this.studyStats.questionsAnswered++;
                this.updateStudyDisplay();
            }

            updateQuizStats(isCorrect) {
                this.studyStats.questionsAnswered++;
                if (isCorrect) {
                    this.studyStats.correctAnswers++;
                }
                this.updateStudyDisplay();
            }

            updateStudyDisplay() {
                const accuracy = this.studyStats.questionsAnswered > 0 ? 
                    Math.round((this.studyStats.correctAnswers / this.studyStats.questionsAnswered) * 100) : 0;
                
                if (this.elements.questionsAnswered) {
                    this.elements.questionsAnswered.textContent = this.studyStats.questionsAnswered;
                }
                
                if (this.elements.accuracy) {
                    this.elements.accuracy.textContent = `${accuracy}%`;
                }
            }

            updateStudyTimer() {
                if (this.studyStats.startTime) {
                    const elapsed = Math.floor((Date.now() - this.studyStats.startTime) / 60000);
                    this.studyStats.studyTime = elapsed;
                    if (this.elements.studyTime) {
                        this.elements.studyTime.textContent = `${elapsed}min`;
                    }
                    setTimeout(() => this.updateStudyTimer(), 60000);
                }
            }

            addBookmark(text, citations) {
                const bookmark = {
                    id: Date.now(),
                    title: text.substring(0, 50) + '...',
                    content: text,
                    citations: citations,
                    timestamp: new Date().toISOString()
                };
                
                this.bookmarks.push(bookmark);
                this.updateBookmarksList();
                showNotification('🔖 Favori ajouté !');
            }

            updateBookmarksList() {
                if (!this.elements.bookmarksList) return;
                
                if (this.bookmarks.length > 0) {
                    this.elements.bookmarksList.innerHTML = this.bookmarks.map(bookmark => `
                        <div class="glass-card rounded-lg p-3 border border-gray-200 dark:border-gray-600">
                            <div class="font-medium text-sm text-gray-900 dark:text-white truncate">${bookmark.title}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${bookmark.citations.length} références</div>
                        </div>
                    `).join('');
                } else {
                    this.elements.bookmarksList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm text-center py-4">Aucun favori</p>';
                }
            }

            exportSession() {
                const data = {
                    chatHistory: this.chatHistory,
                    bookmarks: this.bookmarks,
                    studyStats: this.studyStats,
                    timestamp: new Date().toISOString(),
                    app: 'MedBot Pro by Oubeida Aryan',
                    version: '2.0'
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `medbot-pro-session-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showNotification('💾 Session exportée !');
                this.toggleMenu();
            }

            toggleDarkMode() {
                isDarkMode = !isDarkMode;
                updateDarkMode();
                showNotification(`Mode ${isDarkMode ? 'sombre' : 'clair'} activé`);
                this.toggleMenu();
            }

            async resetApp() {
                if (confirm('⚠️ Réinitialiser complètement l\'application ?\n\nToutes vos données seront définitivement perdues.')) {
                    try {
                        await this.pdfStorage.clearAll();
                        
                        this.pdfText = '';
                        this.pdfPages = [];
                        this.chatHistory = [];
                        this.bookmarks = [];
                        this.studyStats = { 
                            questionsAnswered: 0, 
                            correctAnswers: 0,
                            studyTime: 0, 
                            startTime: null
                        };
                        this.currentFileData = null;
                        
                        this.elements.messagesContainer.innerHTML = '';
                        this.elements.statusText.innerHTML = `
                            <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                            Assistant médical IA
                        `;
                        this.elements.fileInfo?.classList.add('hidden');
                        this.elements.fileControls?.classList.add('hidden');
                        this.elements.processingProgress?.classList.add('hidden');
                        
                        if (this.elements.pdfInput) this.elements.pdfInput.value = '';
                        if (this.elements.messageInput) this.elements.messageInput.value = '';
                        
                        this.showTab('chat');
                        this.loadPDFLibrary();
                        this.updateBookmarksList();
                        this.toggleMenu();
                        
                        showNotification('🔄 Application réinitialisée !');
                    } catch (error) {
                        console.error('Error resetting app:', error);
                        showNotification('Erreur lors de la réinitialisation', 'error');
                    }
                }
            }

            showError(message) {
                this.addMessage(`❌ ${message}`, 'bot');
            }
        }

        // Global instance
        let medBot;
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            medBot = new MedBotPro();
        });
    </script>
</body>
</html>
